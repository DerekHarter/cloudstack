# gather the keys from all cloudstack management servers locally to this ansible management node
# TODO: in future if want to have multipe HA managers, will need to modify to support
#   downloading and injecting multiple cloudstack management keys
- hosts: manager
  tasks:
    - name: Fetch the management key from cloudstack manager to a local file on ansible manager
      fetch:
        src: "/var/lib/cloudstack/management/.ssh/id_rsa.pub"
        dest: "keys/manager-id_rsa.pub"
        flat: true

# now distribute keys to all cloudstack aganets
- hosts: agent
  tasks:
    - name: Copy cloudstack management key from ansible manager buffer to the agent node
      authorized_key:
        user: root
        state: present
        key: "{{ lookup('file', 'keys/manager-id_rsa.pub') }}"

# a bit of a kludge, but we can try and killall of the processes still hanging around for
# the cloudstack user before we attempt to remove the user
# ensure the cloudstack user has been removed from nodes
- hosts: manager agent database
  tasks:
    - name: Kill all cloudstack processes so no error when we remove the user NOTE this is likely to fail here as cloudstack access has probably timed out now
      command: killall -u cloudstack -w
      ignore_errors: true
      
    - name: Remove temporary cloudstack user
      user:
        name: cloudstack
        groups: cloudstack
        state: absent
        remove: yes


# configure cloudstack manager server properties
# setup ssl/https access on the management node that serves the management web UI
#
# We changed procedures a bit.  We expect that the root CA and server keys have been
# generated on the ansible management host.  This play now copies the
# needed keystore file (cloudstack.jks) and configures the cloudstack management https
# server for ssl/https.
# TODO: move these variables to global?  and especially move the password into the
#   secrets file.
- hosts: manager
  vars:
    key_dir: /etc/cloudstack/management
    keystore: "{{ key_dir }}/cloudstack.jks"
    keystore_pass: "Tbiwtts4U"
    
  tasks:

    - name: Copy the certificate keystore we will use to ssl/https authenticate this management server from the ansible manager host
      copy:
        src: "keys/cloudstack.jks"
        dest: "{{ keystore }}"

    - name: Copy the root CA certificate used so we can add to management host list of authorities
      copy:
        src: "keys/HarterRootCA.crt"
        dest: "/usr/local/share/ca-certificates/HarterRootCA.crt"
        
    # TODO: actually it may only be necessary to add the root CA we are using, not any others?
    - name: Copy the server certificate as well to add to list of authorities on this host
      copy:
        src: "keys/cloudstack.crt"
        dest: "/usr/local/share/ca-certificates/cloudstack.crt"
        
          
    - name: Ensure that https access enabled on management server
      lineinfile:
        path: /etc/cloudstack/management/server.properties
        regexp: '^https.enable.*'
        line: 'https.enable=true'

    - name: Ensure that keystore file set in properties
      lineinfile:
        path: /etc/cloudstack/management/server.properties
        regexp: '^https.keystore=.*'
        line: 'https.keystore={{ keystore }}'

    - name: Ensure that keystore password is set in properties
      lineinfile:
        path: /etc/cloudstack/management/server.properties
        regexp: '^https.keystore.password=.*'
        line: 'https.keystore.password={{ keystore_pass }}'

    - name: Update list of authorized ca certificates on the management server
      command: update-ca-certificates
          
    - name: Increase management UI session timeout for convenience
      lineinfile:
        path: /etc/cloudstack/management/server.properties
        regexp: '^session.timeout=.*'
        line: 'session.timeout=60'
        
    - name: Restart the cloudstack management service to pick up https/ssl enabled
      service:
        name: cloudstack-management
        state: restarted


# setup cloudmonkey for command line admin tasks
- hosts: manager
  vars:
    cmk_url: "https://github.com/apache/cloudstack-cloudmonkey/releases/download/6.3.0/cmk.linux.x86-64"
    
  tasks:
    - name: Install cloudmonkey command line admin tool on the manager
      get_url:
        url: "{{ cmk_url }}"
        dest:  /usr/local/bin/cmk
        mode: u+x
      
    - name: Call cloud monkey sync to load apis and enable for initial use
      command: cmk sync

    # TODO: should we (re)configure the config file to use api keys and the https/ssl interface
    #   it would be similar/same as we do next here to configure the ansible/cs tool for
    #   https/ssl access

        
# Generate api key and secret and setup the cloudstack.ini file so that both cloud monkey and the cs cloudstack
# tool used by ansible work to access the api.
# NOTE: the cs tool access won't work until the ssl/https api is up and correctly configured
# NOTE: to test the cloudstack.ini file, do the following on the management host
#       $ python3
#       >>> from cs import CloudStack, read_config
#       >>> cs = CloudStack(**read_config())
#       >>> cs.listUsers()
#   The file created here is working if this reads the config and succeeds to access the api
- hosts: manager
  vars:
    endpoint_url: "https://cloud01.harter.priv:8443/client/api"
    
  tasks:
    - name: Ensure that the cs package used by the ansible cloudstack management lib is present
      apt:
        name: cs
        state: present

    - name: Ensure that python3 sshpubkey package installed for ansible cs management
      apt:
        name: python3-sshpubkeys
        state: present
        
    - name: Lookup the default admin id to query their api keys
      shell: cmk list users name=admin | egrep '"id":' | awk '{print $2}' | tr -d ,
      register: user_id

    - name: Register/create a new set of api user keys for default admin user
      shell: cmk register userkeys id={{ user_id.stdout }}
            
    - name: Lookup the default admin user api key
      shell: cmk get userkeys id={{ user_id.stdout }} | egrep apikey | awk '{print $2}' | tr -d ,\"
      register: apikey
      
    - name: Lookup the default admin user secret key
      shell: cmk get userkeys id={{ user_id.stdout }} | egrep secretkey| awk '{print $2}' | tr -d ,\"
      register: secretkey

    - name: Generate cloudstack.ini file for the ansible cs cloudstack tool
      template:
        src: roles/manager/templates/cloudstack.ini
        dest: /root/.cloudstack.ini


